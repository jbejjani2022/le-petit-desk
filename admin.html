<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>admin - le petite desk</title>
  <link rel="icon" type="image/png" href="static/turtle_base/sprite_0.png">
  <style>
    :root {
      --bg: #3c2626;
      --text: #fdf6ec;
      --accent: #df7829;
      --font-family: 'Outfit', sans-serif;
    }

    body {
      margin: 0;
      font-family: var(--font-family);
      font-weight: 300;
      background: var(--bg);
      color: var(--text);
      padding: 2rem;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      color: var(--accent);
      font-size: 1.5rem;
      margin-bottom: 2rem;
    }

    .control-panel {
      display: none;
    }

    .control-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      background: rgba(253, 246, 236, 0.05);
      border: 1px solid rgba(253, 246, 236, 0.2);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .control-section h2 {
      color: var(--accent);
      margin-top: 0;
      font-size: 1.5rem;
      text-align: center;
    }

    button {
      background: var(--accent);
      color: var(--bg);
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-family: var(--font-family);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-right: 1rem;
      margin-bottom: 0.5rem;
    }

    button:hover {
      background: #e6851f;
      transform: translateY(-2px);
    }

    button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }

    button.danger {
      background: #dc3545;
    }

    button.danger:hover {
      background: #c82333;
    }

    button.small {
      padding: 6px 12px;
      font-size: 0.8rem;
      margin: 0 0 0 8px;
    }

    #qrcode {
      text-align: center;
      margin: 1rem 0;
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: rgba(253, 246, 236, 0.02);
    }

    #qrcode canvas {
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    #qrcode canvas:hover {
      transform: scale(1.05);
    }

    .qr-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      cursor: pointer;
    }

    .qr-modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--text);
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .qr-modal canvas {
      border-radius: 8px;
    }

    .qr-close {
      position: absolute;
      top: -10px;
      right: -10px;
      background: var(--accent);
      color: var(--bg);
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .qr-placeholder {
      color: rgba(253, 246, 236, 0.5);
      font-style: italic;
    }

    .turtle-list {
      list-style: none;
      padding: 0;
    }

    .turtle-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(253, 246, 236, 0.08);
      border: 1px solid rgba(253, 246, 236, 0.15);
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 0.5rem;
    }

    .turtle-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .turtle-sprite {
      width: 40px;
      height: 40px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }

    .turtle-details {
      display: flex;
      flex-direction: column;
    }

    .turtle-name {
      font-size: 1.1rem;
      font-weight: 500;
    }

    .turtle-meta {
      font-size: 0.9rem;
      color: rgba(253, 246, 236, 0.7);
    }

    .session-status {
      padding: 0.5rem 1rem;
      border-radius: 4px;
      font-weight: 500;
      text-align: center;
      margin-bottom: 1rem;
    }

    .session-active {
      background: rgba(40, 167, 69, 0.2);
      border: 1px solid #28a745;
      color: #28a745;
    }

    .session-inactive {
      background: rgba(220, 53, 69, 0.2);
      border: 1px solid #dc3545;
      color: #dc3545;
    }

    .empty-state {
      text-align: center;
      color: rgba(253, 246, 236, 0.5);
      font-style: italic;
      padding: 2rem;
    }

    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }

      h1 {
        font-size: 2rem;
      }

      .turtle-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .turtle-info {
        width: 100%;
      }

      button.small {
        margin: 0.5rem 0 0 0;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Le Petite Desk - Admin</h1>
    
    <div class="control-panel" id="controlPanel">
      <div class="session-status" id="sessionStatus">
        Session Inactive
      </div>

      <div class="control-section">
        <h2>Session Control</h2>
        <button id="startSessionBtn">Start Interactive Session</button>
        <button id="endSessionBtn" class="danger" disabled>End Interactive Session</button>
      </div>

      <div class="control-section">
        <h2>QR Code</h2>
        <div id="qrcode">
          <div class="qr-placeholder">QR code will appear here when session starts</div>
        </div>
      </div>

      <div class="control-section">
        <h2>Active Turtles</h2>
        <ul id="turtleList" class="turtle-list">
          <li class="empty-state">No active turtles</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- QR Code Modal -->
  <div id="qrModal" class="qr-modal">
    <div class="qr-modal-content">
      <button class="qr-close">&times;</button>
      <div id="modalQrCode"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script type="module">
    // Firebase configuration
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB3iNIa3Yp9C1HQpEEjbu6_x5EK93aU9eo",
      authDomain: "le-petite-desk-14f1a.firebaseapp.com",
      databaseURL: "https://le-petite-desk-14f1a-default-rtdb.firebaseio.com",
      projectId: "le-petite-desk-14f1a",
      storageBucket: "le-petite-desk-14f1a.firebasestorage.app",
      messagingSenderId: "477144999138",
      appId: "1:477144999138:web:f476c84f3c745ce9bceabb",
      measurementId: "G-ERHPGQ2CFM"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Authentication
    const PASSWORD = "le-petite-password";
    let isAuthenticated = false;

    function authenticate() {
      const enteredPassword = prompt("Enter admin password:");
      if (enteredPassword === PASSWORD) {
        isAuthenticated = true;
        document.getElementById('controlPanel').style.display = 'block';
        initializeAdmin();
      } else {
        alert("Incorrect Password");
      }
    }

    // Initialize admin panel
    function initializeAdmin() {
      const startSessionBtn = document.getElementById('startSessionBtn');
      const endSessionBtn = document.getElementById('endSessionBtn');
      const qrcodeDiv = document.getElementById('qrcode');
      const turtleList = document.getElementById('turtleList');
      const sessionStatus = document.getElementById('sessionStatus');

      let currentSessionId = null;

      // Listen for session changes
      onValue(ref(database, 'session'), (snapshot) => {
        const session = snapshot.val();
        if (session && session.isActive) {
          currentSessionId = session.sessionId;
          sessionStatus.textContent = `Session Active (ID: ${session.sessionId})`;
          sessionStatus.className = 'session-status session-active';
          startSessionBtn.disabled = true;
          endSessionBtn.disabled = false;
          
          // Generate QR code
          const joinUrl = `${window.location.origin}/join.html?session=${session.sessionId}`;
          qrcodeDiv.innerHTML = '';
          
          // Check if QRious is available
          if (typeof QRious !== 'undefined') {
            try {
              const canvas = document.createElement('canvas');
              const qr = new QRious({
                element: canvas,
                value: joinUrl,
                size: 200,
                padding: 10
              });
              
              // Add click handler to show modal
              canvas.addEventListener('click', () => {
                showQrModal(joinUrl);
              });
              
              qrcodeDiv.appendChild(canvas);
            } catch (error) {
              console.error('QR Code generation error:', error);
              showFallbackUrl();
            }
          } else {
            showFallbackUrl();
          }
          
          function showFallbackUrl() {
            qrcodeDiv.innerHTML = `
              <div style="padding: 1rem; text-align: center;">
                <p style="color: var(--text); margin-bottom: 1rem;">Join URL:</p>
                <p style="color: var(--accent); font-size: 0.9rem; word-break: break-all;">${joinUrl}</p>
                <p style="color: rgba(253, 246, 236, 0.6); font-size: 0.8rem; margin-top: 1rem;">Share this URL with participants</p>
              </div>
            `;
          }
        } else {
          currentSessionId = null;
          sessionStatus.textContent = 'Session Inactive';
          sessionStatus.className = 'session-status session-inactive';
          startSessionBtn.disabled = false;
          endSessionBtn.disabled = true;
          qrcodeDiv.innerHTML = '<div class="qr-placeholder">QR code will appear here when session starts</div>';
        }
      });

      // Listen for turtle changes
      onValue(ref(database, 'turtles'), (snapshot) => {
        const turtles = snapshot.val();
        renderTurtles(turtles);
      });

      // Start session
      startSessionBtn.addEventListener('click', async () => {
        const sessionId = Date.now().toString();
        await set(ref(database, 'turtles'), null);
        await set(ref(database, 'session'), {
          isActive: true,
          sessionId: sessionId
        });
      });

      // End session
      endSessionBtn.addEventListener('click', async () => {
        await set(ref(database, 'session'), {
          isActive: false,
          sessionId: null
        });
        await set(ref(database, 'turtles'), null);
      });

      function renderTurtles(turtles) {
        if (!turtles) {
          turtleList.innerHTML = '<li class="empty-state">No active turtles</li>';
          return;
        }

        const turtleEntries = Object.entries(turtles);
        if (turtleEntries.length === 0) {
          turtleList.innerHTML = '<li class="empty-state">No active turtles</li>';
          return;
        }

        turtleList.innerHTML = turtleEntries.map(([turtleId, turtleData]) => {
          const spawnDate = new Date(turtleData.spawnTime);
          const turtleSprites = [
            'static/turtle_spawn/turtle_0/sprite_0.png',
            'static/turtle_spawn/turtle_1/sprite_0.png', 
            'static/turtle_spawn/turtle_2/sprite_0.png'
          ];

          return `
            <li class="turtle-item">
              <div class="turtle-info">
                <div class="turtle-sprite" style="background-image: url('${turtleSprites[turtleData.turtleType]}')"></div>
                <div class="turtle-details">
                  <div class="turtle-name">${turtleData.name}</div>
                  <div class="turtle-meta">${spawnDate.toLocaleTimeString()}</div>
                </div>
              </div>
              <button class="danger small" onclick="removeTurtle('${turtleId}')">Remove</button>
            </li>
          `;
        }).join('');
      }

      // QR Modal functionality
      function showQrModal(url) {
        const modal = document.getElementById('qrModal');
        const modalQrCode = document.getElementById('modalQrCode');
        
        // Clear previous content
        modalQrCode.innerHTML = '';
        
        // Create larger QR code for modal
        if (typeof QRious !== 'undefined') {
          try {
            const canvas = document.createElement('canvas');
            const qr = new QRious({
              element: canvas,
              value: url,
              size: 400,
              padding: 20
            });
            modalQrCode.appendChild(canvas);
          } catch (error) {
            console.error('Modal QR Code generation error:', error);
            modalQrCode.innerHTML = `
              <div style="padding: 2rem; text-align: center; color: #333;">
                <p style="margin-bottom: 1rem; font-weight: bold;">Join URL:</p>
                <p style="color: var(--accent); font-size: 1.1rem; word-break: break-all;">${url}</p>
              </div>
            `;
          }
        }
        
        modal.style.display = 'block';
      }
      
      // Close modal functionality
      const modal = document.getElementById('qrModal');
      const closeBtn = document.querySelector('.qr-close');
      
      closeBtn.addEventListener('click', () => {
        modal.style.display = 'none';
      });
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.style.display = 'none';
        }
      });
      
      // Close modal on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.style.display === 'block') {
          modal.style.display = 'none';
        }
      });

      // Make removeTurtle available globally
      window.removeTurtle = async (turtleId) => {
        await remove(ref(database, `turtles/${turtleId}`));
      };
    }

    // Start authentication flow
    authenticate();
  </script>
</body>
</html>