<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MDXNW9DF26"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-MDXNW9DF26');
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>admin - le petit desk</title>
  <link rel="icon" type="image/png" href="static/turtle_base/sprite_0.png">
  <style>
    :root {
      --bg: #3c2626;
      --text: #fdf6ec;
      --accent: #df7829;
      --font-family: 'Outfit', sans-serif;
    }

    body {
      margin: 0;
      font-family: var(--font-family);
      font-weight: 300;
      background: var(--bg);
      color: var(--text);
      padding: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    .container {
      max-width: 800px;
      width: 100%;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      color: var(--accent);
      font-size: 1.5rem;
      margin-bottom: 2rem;
    }
    
    /* Login Form Styles */
    #login-container {
      background: transparent;
      border: none;
      border-radius: 0;
      padding: 2rem;
      max-width: 400px;
      margin: 0 auto;
    }

    #login-container h2 {
      text-align: center;
      color: var(--accent);
      margin-top: 0;
    }
    
    input[type="email"], input[type="password"] {
      background: transparent;
      border: none;
      border-bottom: 2px solid var(--text);
      color: var(--text);
      font-family: var(--font-family);
      font-weight: 300;
      font-size: 1.1rem;
      outline: none;
      padding: 0.8rem;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 1.5rem;
      transition: border-bottom-color 0.3s ease;
    }
    
    input[type="email"]:focus, input[type="password"]:focus {
      border-bottom-color: var(--accent);
    }
    
    #login-error {
      color: #ff6b6b;
      text-align: center;
      min-height: 1.2em;
      margin-top: 1rem;
    }

    .control-panel {
      display: none;
    }

    .control-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      background: rgba(253, 246, 236, 0.05);
      border: 1px solid rgba(253, 246, 236, 0.2);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .control-section h2 {
      color: var(--accent);
      margin-top: 0;
      font-size: 1.5rem;
      text-align: center;
    }

    button {
      background: var(--accent);
      color: var(--bg);
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-family: var(--font-family);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 0 0.5rem 0.5rem;
    }
    
    #login-button {
      width: 100%;
      margin: 0;
    }

    button:hover {
      background: #e6851f;
      transform: translateY(-2px);
    }

    button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }

    button.danger {
      background: #dc3545;
    }

    button.danger:hover {
      background: #c82333;
    }

    button.small {
      padding: 6px 12px;
      font-size: 0.8rem;
      margin: 0 0 0 8px;
      white-space: nowrap;
      flex-shrink: 0;
    }

    #qrcode {
      text-align: center;
      margin: 1rem 0;
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: rgba(253, 246, 236, 0.02);
    }

    #qrcode canvas {
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    #qrcode canvas:hover {
      transform: scale(1.05);
    }

    .qr-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      cursor: pointer;
    }

    .qr-modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--text);
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      max-width: 90vw;
      max-height: 90vh;
      box-sizing: border-box;
      overflow: hidden;
    }

    .qr-modal canvas {
      border-radius: 8px;
      width: 100%;
      height: auto;
      max-width: 80vw;
      max-height: 80vh;
    }

    .qr-close {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--accent);
      color: var(--bg);
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      padding: 0;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }

    .qr-placeholder {
      color: rgba(253, 246, 236, 0.5);
      font-style: italic;
    }

    .turtle-list {
      list-style: none;
      padding: 0;
      width: 100%;
    }

    .turtle-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(253, 246, 236, 0.08);
      border: 1px solid rgba(253, 246, 236, 0.15);
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 0.5rem;
    }

    .turtle-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex: 1;
      min-width: 0;
    }

    .turtle-sprite {
      width: 40px;
      height: 40px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }

    .turtle-details {
      display: flex;
      flex-direction: column;
    }

    .turtle-name {
      font-size: 1.1rem;
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .turtle-meta {
      font-size: 0.9rem;
      color: rgba(253, 246, 236, 0.7);
    }

    .session-status {
      padding: 0.5rem 1rem;
      border-radius: 4px;
      font-weight: 500;
      text-align: center;
      margin-bottom: 1rem;
    }

    .session-active {
      background: rgba(40, 167, 69, 0.2);
      border: 1px solid #28a745;
      color: #28a745;
    }

    .session-inactive {
      background: rgba(220, 53, 69, 0.2);
      border: 1px solid #dc3545;
      color: #dc3545;
    }

    .empty-state {
      text-align: center;
      color: rgba(253, 246, 236, 0.5);
      font-style: italic;
      padding: 2rem;
    }

    @media (max-width: 768px) {
      body { padding: 1rem; }
      h1 { font-size: 2rem; }
      .turtle-item { flex-direction: row; align-items: center; gap: 0.5rem; }
      .turtle-info { flex: 1; min-width: 0; }
      button.small { margin: 0 0 0 8px; }
      .qr-modal-content { width: 90vw; max-width: 90vw; max-height: 90vh; padding: 1rem; }
      .qr-modal canvas { max-width: 100%; max-height: 80vh; }
      .qr-close { top: 8px; right: 8px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Le Petit Desk Admin</h1>

    <div id="login-container">
      <h2>Login</h2>
      <input type="email" id="admin-email" placeholder="Email" autocomplete="email" />
      <input type="password" id="admin-password" placeholder="Password" autocomplete="current-password" />
      <button id="login-button">Sign In</button>
      <p id="login-error"></p>
    </div>
    
    <div class="control-panel" id="controlPanel">
      <div class="session-status" id="sessionStatus">
        Session Inactive
      </div>

      <div class="control-section">
        <h2>Session Control</h2>
        <button id="startSessionBtn">Start Interactive Session</button>
        <button id="endSessionBtn" class="danger" disabled>End Interactive Session</button>
        <button id="startRaceBtn" disabled>Start Race</button>
        <button id="zenBtn" disabled>Zen Mode</button>
      </div>

      <div class="control-section">
        <h2>QR Code</h2>
        <div id="qrcode">
          <div class="qr-placeholder">QR code will appear here when session starts</div>
        </div>
      </div>

      <div class="control-section">
        <h2>Active Turtles</h2>
        <ul id="turtleList" class="turtle-list">
          <li class="empty-state">No active turtles</li>
        </ul>
      </div>
    </div>
  </div>

  <div id="qrModal" class="qr-modal">
    <div class="qr-modal-content">
      <button class="qr-close">&times;</button>
      <div id="modalQrCode"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script type="module">
    // Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDcUEzJ33ZCM9U2PCkBgxREsAjBBC2InoE",
      authDomain: "le-petit-desk.firebaseapp.com",
      databaseURL: "https://le-petit-desk-default-rtdb.firebaseio.com",
      projectId: "le-petit-desk",
      storageBucket: "le-petit-desk.firebasestorage.app",
      messagingSenderId: "245188577687",
      appId: "1:245188577687:web:9d3b0bbbf56486f69e1cd2",
      measurementId: "G-MDXNW9DF26"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth();

    // DOM Elements
    const loginContainer = document.getElementById('login-container');
    const controlPanel = document.getElementById('controlPanel');
    const loginButton = document.getElementById('login-button');
    const emailInput = document.getElementById('admin-email');
    const passwordInput = document.getElementById('admin-password');
    const loginError = document.getElementById('login-error');

    // Authentication Logic
    loginButton.addEventListener('click', () => {
      const email = emailInput.value;
      const password = passwordInput.value;
      loginError.textContent = ''; // Clear previous errors

      signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          console.log("Admin signed in:", userCredential.user.uid);
          loginContainer.style.display = 'none';
          controlPanel.style.display = 'block';
          initializeAdminPanel();
        })
        .catch((error) => {
          console.error("Login failed:", error.message);
          loginError.textContent = "Login failed. Please check your credentials.";
        });
    });

    // Initialize admin panel only after successful login
    function initializeAdminPanel() {
      const startSessionBtn = document.getElementById('startSessionBtn');
      const endSessionBtn = document.getElementById('endSessionBtn');
      const startRaceBtn = document.getElementById('startRaceBtn');
      const zenBtn = document.getElementById('zenBtn');
      const qrcodeDiv = document.getElementById('qrcode');
      const turtleList = document.getElementById('turtleList');
      const sessionStatus = document.getElementById('sessionStatus');
      const modal = document.getElementById('qrModal');
      const closeBtn = document.querySelector('.qr-close');
      
      let currentSession = null;
      let activeTurtleCount = 0;

      // Listen for session changes
      onValue(ref(database, 'session'), (snapshot) => {
        currentSession = snapshot.val();
        updateButtonStates();
        
        if (currentSession && currentSession.isActive) {
          const raceStateText = currentSession.raceState ? ` - ${currentSession.raceState.toUpperCase()}` : '';
          sessionStatus.textContent = `Session Active (ID: ${currentSession.sessionId})${raceStateText}`;
          sessionStatus.className = 'session-status session-active';
          startSessionBtn.disabled = true;
          endSessionBtn.disabled = false;
          generateQrCode(`${window.location.origin}/join.html?session=${currentSession.sessionId}`);
        } else {
          sessionStatus.textContent = 'Session Inactive';
          sessionStatus.className = 'session-status session-inactive';
          startSessionBtn.disabled = false;
          endSessionBtn.disabled = true;
          qrcodeDiv.innerHTML = '<div class="qr-placeholder">QR code will appear here when session starts</div>';
        }
      });

      // Listen for turtle changes
      onValue(ref(database, 'turtles'), (snapshot) => {
        const turtles = snapshot.val() || {};
        activeTurtleCount = Object.keys(turtles).length;
        updateButtonStates();
        renderTurtles(turtles);
      });

      // Update button states based on session and turtle count
      function updateButtonStates() {
        const isActive = currentSession && currentSession.isActive;
        const raceState = currentSession ? (currentSession.raceState || 'idle') : 'idle';
        
        // Start Race button: enabled when session active, race state is idle/finished, and has turtles
        startRaceBtn.disabled = !isActive || 
          !(raceState === 'idle' || raceState === 'finished') || 
          activeTurtleCount === 0;
        
        // Zen Mode button: enabled when session active and race state is starting/racing/finished
        zenBtn.disabled = !isActive || 
          !(raceState === 'starting' || raceState === 'racing' || raceState === 'finished');
      }

      // Event listeners for session control
      startSessionBtn.addEventListener('click', async () => {
        const sessionId = Date.now().toString();
        await set(ref(database, 'turtles'), null);
        await set(ref(database, 'session'), { isActive: true, sessionId: sessionId, raceState: 'idle' });
      });

      endSessionBtn.addEventListener('click', async () => {
        await set(ref(database, 'session'), { isActive: false, sessionId: null, raceState: 'idle' });
        await set(ref(database, 'turtles'), null);
      });

      // Event listeners for race control
      startRaceBtn.addEventListener('click', async () => {
        await set(ref(database, 'session/raceState'), 'starting');
        // After 4 seconds, automatically change to racing
        setTimeout(async () => {
          await set(ref(database, 'session/raceState'), 'racing');
        }, 4000);
      });

      zenBtn.addEventListener('click', async () => {
        await set(ref(database, 'session/raceState'), 'idle');
      });

      function generateQrCode(url) {
        qrcodeDiv.innerHTML = ''; // Clear placeholder
        try {
          const canvas = document.createElement('canvas');
          new QRious({ element: canvas, value: url, size: 200, padding: 10 });
          canvas.addEventListener('click', () => showQrModal(url));
          qrcodeDiv.appendChild(canvas);
        } catch (error) {
          console.error('QR Code generation error:', error);
          qrcodeDiv.innerHTML = `<div style="padding: 1rem; text-align: center;"><p>Join URL:</p><p style="color: var(--accent); font-size: 0.9rem; word-break: break-all;">${url}</p></div>`;
        }
      }

      function renderTurtles(turtles) {
        const turtleEntries = turtles ? Object.entries(turtles) : [];
        if (turtleEntries.length === 0) {
          turtleList.innerHTML = '<li class="empty-state">No active turtles</li>';
          return;
        }

        turtleList.innerHTML = turtleEntries.map(([turtleId, data]) => {
          const spawnDate = new Date(data.spawnTime);
          const spritePath = `static/turtles_to_spawn/turtle_${data.turtleType}/sprite_0.png`;
          return `
            <li class="turtle-item">
              <div class="turtle-info">
                <div class="turtle-sprite" style="background-image: url('${spritePath}')"></div>
                <div class="turtle-details">
                  <div class="turtle-name">${data.name}</div>
                  <div class="turtle-meta">${spawnDate.toLocaleTimeString()}</div>
                </div>
              </div>
              <button class="danger small" data-turtle-id="${turtleId}">Remove</button>
            </li>`;
        }).join('');
      }
      
      // Delegated event listener for remove buttons
      turtleList.addEventListener('click', (e) => {
        if (e.target && e.target.matches('button.danger.small')) {
          const turtleId = e.target.dataset.turtleId;
          if (turtleId) {
            remove(ref(database, `turtles/${turtleId}`));
          }
        }
      });

      function showQrModal(url) {
        const modalQrCode = document.getElementById('modalQrCode');
        modalQrCode.innerHTML = '';
        try {
          const canvas = document.createElement('canvas');
          new QRious({ element: canvas, value: url, size: 400, padding: 20 });
          modalQrCode.appendChild(canvas);
        } catch (error) {
          modalQrCode.innerHTML = `<div style="padding: 2rem; text-align: center; color: #333;"><p>Join URL:</p><p style="color: var(--accent); font-size: 1.1rem; word-break: break-all;">${url}</p></div>`;
        }
        modal.style.display = 'block';
      }
      
      closeBtn.addEventListener('click', () => { modal.style.display = 'none'; });
      modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') modal.style.display = 'none'; });
    }
  </script>
</body>
</html>